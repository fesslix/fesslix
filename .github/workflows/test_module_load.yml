name: Test loading of the Python module

on:
  workflow_run:
    workflows: ["Build and publish Fesslix as Python module"]
    types:
      - completed
  workflow_dispatch:  # manually trigger workflow

jobs:
  wait-for-pypi:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      ready: true  # dummy output just to link dependency
    steps:
      - name: Wait for PyPI to synchronize (5 minutes)
        if: ${{ github.event_name == 'workflow_run' }}
        run: sleep 300

  test-module-load:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ${{ matrix.os }}
    needs: [wait-for-pypi]
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-14, macos-13 ]  # List of OS to build on Â»  ubuntu-latest, windows-latest, macos-14, macos-13
        python: ['3.13']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # Get the code from the repository
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Upgrade pip and prepare environment
        run: |
          python -m pip install --upgrade pip

      - name: Install fesslix from PyPI
        run: |
          python -m pip install --no-cache-dir --upgrade fesslix

      - name: Run test script
        run: |
          run: python test_module_load.py
        working-directory: tests
        
        
